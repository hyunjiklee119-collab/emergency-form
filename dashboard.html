<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>비상대피 현황 대시보드</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        h2 { text-align: center; color: #1a237e; margin: 0 0 20px; }

        .dashboard-container { 
            max-width: 900px; 
            margin: 0 auto; 
            display: grid; 
            gap: 20px; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
        }

        /* 모바일 레이아웃을 위한 미디어 쿼리 */
        @media (max-width: 768px) {
            .dashboard-container {
                grid-template-columns: repeat(3, 1fr); /* 3개로 표기 */
            }
            .score-card:nth-child(4) {
                display: none; /* 내방객 인원 숨기기 */
            }
        }
        @media (max-width: 480px) {
            .dashboard-container {
                grid-template-columns: 1fr; /* 1개로 표기 */
                padding: 0 10px; /* 좌우 여백 추가 */
            }
        }

        .score-card { 
            background: #fff; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            text-align: center; 
        }
        .score-card h3 { color: #1a237e; margin: 0 0 10px 0; font-size: 1rem; }
        .score-card .value { font-size: 2.5rem; font-weight: bold; color: #007bff; }
        #lastUpdated { font-size: 0.8rem; color: #888; margin-top: 20px; text-align: center; }
        .loading { text-align: center; padding: 20px; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 2s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .data-table-container { 
            max-width: 900px; 
            margin: 20px auto; 
            background: #fff; 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            overflow-x: auto; 
        }
        .filter-container { display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 15px; }
        .filter-container input[type="date"] { padding: 8px; border: 1px solid #ccc; border-radius: 6px; }
        .filter-container button { padding: 8px 15px; border: none; background: #007bff; color: #fff; border-radius: 6px; cursor: pointer; }
        .filter-container button:hover { background: #0056b3; }
        .report-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .report-table th, .report-table td { border: 1px solid #ddd; padding: 10px; text-align: left; font-size: 0.9rem; }
        .report-table th { background-color: #f2f2f2; font-weight: bold; }
        .report-table tbody tr:nth-child(even) { background-color: #f9f9f9; }
        .no-data { text-align: center; color: #888; padding: 20px; }
        
        .pagination { display: flex; justify-content: center; align-items: center; gap: 5px; margin-top: 20px; }
        .page-btn { padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; background: #fff; cursor: pointer; }
        .page-btn.active { background: #007bff; color: #fff; border-color: #007bff; }

        /* 팝업 스타일 */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-btn:hover, .close-btn:focus { color: #000; text-decoration: none; cursor: pointer; }
        .note-popup-content { white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body>

<h2>비상대피 현황 대시보드</h2>
<div class="dashboard-container" id="dashboard">
    <div class="score-card">
        <h3>총 대피대상자</h3>
        <p class="value" id="totalCount">-</p>
    </div>
    <div class="score-card">
        <h3>대피완료 인원</h3>
        <p class="value" id="evacuatedCount">-</p>
    </div>
    <div class="score-card">
        <h3>미대피 인원</h3>
        <p class="value" id="remainingCount">-</p>
    </div>
    <div class="score-card">
        <h3>내방객 인원</h3>
        <p class="value" id="visitorCount">-</p>
    </div>
</div>
<div id="lastUpdated"></div>
<div class="loading" id="loadingMessage">
    <div class="loader"></div>
    <p>데이터를 불러오는 중...</p>
</div>

<div class="data-table-container">
    <div class="filter-container">
        <label for="startDate">시작일:</label>
        <input type="date" id="startDate">
        <label for="endDate">종료일:</label>
        <input type="date" id="endDate">
        <button onclick="fetchData()">조회</button>
    </div>
    <table class="report-table">
        <thead>
            <tr>
                <th>보고일시</th>
                <th>보고자</th>
                <th>소속</th>
                <th>대피완료</th>
                <th>미대피</th>
                <th>특이사항</th>
            </tr>
        </thead>
        <tbody id="reportTableBody">
                    </tbody>
    </table>
    <div id="noDataMessage" class="no-data" style="display:none;">
        해당 기간에 보고된 데이터가 없습니다.
    </div>
    <div class="pagination" id="pagination"></div>
</div>

<div id="noteModal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h3>특이사항 상세 내용</h3>
        <p id="notePopupContent" class="note-popup-content"></p>
    </div>
</div>

<script>
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbysncTbZ4pE6A4o4acDRaJ3SXXzWE5SwmkIUd3-Vzc-TB7tvNTomUs6fSpEYFLLiWks/exec";
    
    const totalCountEl = document.getElementById("totalCount");
    const evacuatedCountEl = document.getElementById("evacuatedCount");
    const remainingCountEl = document.getElementById("remainingCount");
    const visitorCountEl = document.getElementById("visitorCount");
    const lastUpdatedEl = document.getElementById("lastUpdated");
    const loadingMessageEl = document.getElementById("loadingMessage");
    const dashboardContainer = document.getElementById("dashboard");
    const reportTableBody = document.getElementById("reportTableBody");
    const noDataMessage = document.getElementById("noDataMessage");
    const startDateInput = document.getElementById("startDate");
    const endDateInput = document.getElementById("endDate");
    const paginationContainer = document.getElementById("pagination");
    const noteModal = document.getElementById("noteModal");
    const closeBtn = document.querySelector(".close-btn");
    const notePopupContent = document.getElementById("notePopupContent");

    const today = new Date().toISOString().slice(0, 10);
    startDateInput.value = today;
    endDateInput.value = today;

    let allReports = [];
    const itemsPerPage = 10;
    let currentPage = 1;
    let totalPages = 1;

    async function fetchData(page = 1) {
        loadingMessageEl.style.display = 'block';
        dashboardContainer.style.display = 'none';

        const startDate = startDateInput.value;
        const endDate = endDateInput.value;

        try {
            const response = await fetch(`${WEBAPP_URL}?action=getReports&startDate=${startDate}&endDate=${endDate}`);
            const result = await response.json();
            
            if (result.result === "success") {
                const data = result.data;
                totalCountEl.textContent = data.total;
                evacuatedCountEl.textContent = data.evacuated;
                remainingCountEl.textContent = data.remaining;
                visitorCountEl.textContent = data.visitorTotal;
                lastUpdatedEl.textContent = `마지막 업데이트: ${new Date().toLocaleTimeString()}`;

                allReports = result.reports;
                currentPage = page;
                displayReports();
            } else {
                console.error("API 오류:", result.error);
                totalCountEl.textContent = "에러";
                noDataMessage.textContent = "데이터를 불러오는 중 오류가 발생했습니다.";
                noDataMessage.style.display = 'block';
            }
        } catch (error) {
            console.error("데이터 로딩 실패:", error);
            totalCountEl.textContent = "연결 오류";
            noDataMessage.textContent = "네트워크 연결 오류입니다.";
            noDataMessage.style.display = 'block';
        } finally {
            loadingMessageEl.style.display = 'none';
            dashboardContainer.style.display = 'grid';
        }
    }

    function displayReports() {
        reportTableBody.innerHTML = '';
        noDataMessage.style.display = 'none';

        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const reportsToDisplay = allReports.slice(startIndex, endIndex);

        if (reportsToDisplay.length > 0) {
            reportsToDisplay.forEach(report => {
                const row = document.createElement('tr');
                const noteContent = report.note ? `<span style="cursor:pointer;" onclick="showNotePopup('${report.note.replace(/'/g, "\\'")}')">*</span>` : '';
                row.innerHTML = `
                    <td>${report.date}</td>
                    <td>${report.reporter}</td>
                    <td>${report.division} / ${report.department}</td>
                    <td>${report.evacuated}</td>
                    <td>${report.remaining}</td>
                    <td>${noteContent}</td>
                `;
                reportTableBody.appendChild(row);
            });
        } else {
            noDataMessage.style.display = 'block';
        }

        renderPagination();
    }

    function showNotePopup(note) {
        notePopupContent.textContent = note;
        noteModal.style.display = 'block';
    }

    function renderPagination() {
        paginationContainer.innerHTML = '';
        totalPages = Math.ceil(allReports.length / itemsPerPage);

        for (let i = 1; i <= totalPages; i++) {
            const pageBtn = document.createElement('button');
            pageBtn.classList.add('page-btn');
            pageBtn.textContent = i;
            if (i === currentPage) {
                pageBtn.classList.add('active');
            }
            pageBtn.addEventListener('click', () => {
                currentPage = i;
                displayReports();
            });
            paginationContainer.appendChild(pageBtn);
        }
    }

    closeBtn.onclick = function() {
        noteModal.style.display = 'none';
    }

    window.onclick = function(event) {
        if (event.target == noteModal) {
            noteModal.style.display = 'none';
        }
    }

    // 페이지 로드 시 즉시 실행
    fetchData();
    setInterval(fetchData, 10000); // 10초마다 데이터 새로고침
</script>

</body>
</html>
