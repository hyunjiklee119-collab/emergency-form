<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ëª¨ë°”ì¼ ëŒ€í”¼ í˜„í™©íŒ</title>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background: #f8f9fa;
    margin: 0;
    padding: 10px;
    color: #333;
  }
  .summary-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 12px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    overflow: hidden;
  }
  .summary-table th, .summary-table td {
    padding: 8px 3px;
    text-align: center;
    border: 1px solid #eee;
  }
  .summary-table th {
    background: #e9ecef;
    font-size: 0.75rem;
    font-weight: bold;
    color: #495057;
  }
  .summary-table td {
    font-size: 0.85rem;
    font-weight: bold;
  }
  .summary-table .total-row {
    font-weight: bold;
    background: #f1f1f1;
  }
  .filter-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    margin-bottom: 15px;
  }
  .filter-controls label {
    font-size: 0.9rem;
    color: #555;
  }
  .filter-controls input[type="date"] {
    padding: 6px;
    border-radius: 5px;
    border: 1px solid #ccc;
    font-size: 0.9rem;
  }
  .accordion-container {
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    overflow: hidden;
  }
  .accordion-item {
    border-bottom: 1px solid #eee;
  }
  .accordion-item:last-child {
    border-bottom: none;
  }
  .accordion-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    cursor: pointer;
    background: #f4f4f4;
    font-weight: bold;
    font-size: 1rem;
  }
  .accordion-content {
    display: none;
    padding: 0 15px;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out, padding 0.3s ease-out;
  }
  .accordion-content.active {
    display: block;
    max-height: 500px;
    padding: 10px 15px;
  }
  .dept-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    cursor: pointer;
  }
  .dept-name { font-size: 0.9rem; }
  .status {
    font-weight: bold;
    font-size: 1rem;
  }
  .ok { color: #28a745; }
  .warn { color: #dc3545; }
  .pending { color: #ffc107; }

  .footer {
    text-align: center;
    margin-top: 12px;
  }
  button {
    padding: 10px 20px;
    font-size: 1rem;
    border: none;
    border-radius: 8px;
    background: #007bff;
    color: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    cursor: pointer;
  }
  button:active { background: #0056b3; }
  #lastUpdated {
    text-align: center;
    font-size: 0.75rem;
    color: #777;
    margin-top: 5px;
  }
  /* íŒì—… ìŠ¤íƒ€ì¼ */
  .popup {
    display: none;
    position: fixed;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  .popup-content {
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }
  .popup-content h3 {
    margin-top: 0;
    border-bottom: 2px solid #007bff;
    padding-bottom: 10px;
  }
  .popup-content .input-group {
    margin-bottom: 15px;
  }
  .popup-content label {
    display: block;
    font-size: 0.9rem;
    color: #555;
    margin-bottom: 5px;
  }
  .popup-content input, .popup-content textarea {
    width: calc(100% - 20px);
    padding: 8px 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
  }
  .popup-content .popup-btn {
    width: calc(50% - 5px);
    margin-top: 10px;
  }
  .popup-content .close-btn {
    background: #6c757d;
  }
  .popup-content .input-group.checkbox-group {
      display: flex;
      align-items: center;
      justify-content: space-between;
  }
  .popup-content .input-group.checkbox-group label {
      margin-bottom: 0;
  }
  .popup-content .input-group.checkbox-group input[type="checkbox"] {
      width: auto;
  }
</style>
</head>
<body>

<div class="filter-controls">
  <label for="startDate">ì‹œì‘ì¼:</label>
  <input type="date" id="startDate">
  <label for="endDate">ì¢…ë£Œì¼:</label>
  <input type="date" id="endDate">
  <button onclick="filterData()">ì¡°íšŒ</button>
</div>

<table class="summary-table">
  <thead>
    <tr>
      <th rowspan="2">division</th>
      <th colspan="3">ì„ì§ì› & í˜‘ë ¥ì‚¬</th>
      <th colspan="3">ë‚´ë°©ê°</th>
    </tr>
    <tr>
      <th>total</th>
      <th>evacuated</th>
      <th>remaining</th>
      <th>total</th>
      <th>evacuated</th>
      <th>remaining</th>
    </tr>
  </thead>
  <tbody id="pivotTableBody">
    </tbody>
  <tfoot>
    <tr class="total-row">
      <td>ì´ê³„</td>
      <td id="grandTotalTotal">-</td>
      <td id="grandTotalEvacuated">-</td>
      <td id="grandTotalRemaining">-</td>
      <td id="grandTotalVisitorTotal">-</td>
      <td id="grandTotalVisitorEvacuated">-</td>
      <td id="grandTotalVisitorRemaining">-</td>
    </tr>
  </tfoot>
</table>

<div class="accordion-container" id="accordionContainer">
</div>

<div class="footer">
  <button onclick="syncData()">ğŸ”„ ë™ê¸°í™”</button>
  <p id="lastUpdated">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: -</p>
</div>

<div id="reportPopup" class="popup">
  <div class="popup-content">
    <h3 id="popupTitle"></h3>
    <div class="input-group">
      <label for="popupTotal">ì´ ì¸ì›</label>
      <input type="number" id="popupTotal">
    </div>
    <div class="input-group">
      <label for="popupEvacuated">ëŒ€í”¼ì™„ë£Œ</label>
      <input type="number" id="popupEvacuated">
    </div>
    <div class="input-group">
      <label for="popupRemaining">ë¯¸ëŒ€í”¼</label>
      <input type="number" id="popupRemaining" disabled>
    </div>
    
    <div class="input-group checkbox-group">
        <label for="popupHasVisitor">ë‚´ë°©ê° í¬í•¨</label>
        <input type="checkbox" id="popupHasVisitor">
    </div>
    <div id="visitorFields" style="display:none;">
        <div class="input-group">
          <label for="popupVisitorTotal">ë‚´ë°©ê° ì´ì›</label>
          <input type="number" id="popupVisitorTotal" min="0">
        </div>
        <div class="input-group">
          <label for="popupVisitorEvacuated">ë‚´ë°©ê° ëŒ€í”¼ì™„ë£Œ</label>
          <input type="number" id="popupVisitorEvacuated" min="0">
        </div>
        <div class="input-group">
          <label for="popupVisitorRemaining">ë‚´ë°©ê° ë¯¸ëŒ€í”¼</label>
          <input type="number" id="popupVisitorRemaining" disabled>
        </div>
    </div>

    <div class="input-group">
      <label for="popupNotes">íŠ¹ì´ì‚¬í•­</label>
      <textarea id="popupNotes"></textarea>
    </div>
    <button id="saveBtn" class="popup-btn">ì €ì¥</button>
    <button class="close-btn popup-btn" onclick="closePopup()">ë‹«ê¸°</button>
  </div>
</div>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyAc7avR0ZbVjSVaWgmlR7BtSiJVA0hDxAhvMDCLCoDVB2xxXeDrdQzXpLPGX-wGXRp/exec";
let currentReportData = null;

const departments = {
    'SYSTEMì‚¬ì—…ë¶€': ['ì‚¬ì—…ë¶€ ê³µí†µ', 'ì˜ì—…íŒ€', 'CSíŒ€', 'ì œì¡°íŒ€', 'ìƒì‚°ê¸°ìˆ íŒ€', 'í’ˆì§ˆG'],
    'INFRAì‚¬ì—…ë¶€': ['ì‚¬ì—…ë¶€ ê³µí†µ', 'ENCì‚¬ì—…íŒ€', 'EPCì‚¬ì—…íŒ€'],
    'ê²½ì˜ì§€ì›ì‹¤': ['ì‚¬ì—…ë¶€ ê³µí†µ', 'ì¬ë¬´íŒ€', 'ì¸ì‚¬íŒ€', 'ì •ë³´ì „ëµíŒ€', 'ê¸°íšG', 'ì¤€ë²•ê²½ì˜G'],
    'ì§ì†(ì—°êµ¬ì†Œ, êµ¬ë§¤íŒ€, ì•ˆì „í™˜ê²½, ê¸€ë¡œë²ŒTF)': ['ì‚¬ì—…ë¶€ ê³µí†µ', 'ì—°êµ¬ì†Œ', 'êµ¬ë§¤íŒ€', 'ì•ˆì „í™˜ê²½íŒ€', 'ê¸€ë¡œë²ŒTF'],
    'í˜‘ë ¥ì‚¬': ['í˜‘ë ¥ì‚¬'],
    'ê¸°íƒ€': ['ê¸°íƒ€']
};

async function fetchData(startDate = null, endDate = null) {
  try {
    let url = `${WEBAPP_URL}?action=getSummary`;
    if (startDate) {
      url += `&startDate=${startDate}`;
    }
    if (endDate) {
      url += `&endDate=${endDate}`;
    }

    const res = await fetch(url);
    const data = await res.json();
    if (data.result === "success") {
      const summary = data.summary || [];
      const pivotTableData = aggregateDataForPivot(summary);
      renderPivotTable(pivotTableData);
      renderAccordion(summary);
    }
  } catch (error) {
    console.error("Error fetching data:", error);
    renderAccordion([]);
  }
  document.getElementById("lastUpdated").textContent = "ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: " + new Date().toLocaleTimeString();
}

function filterData() {
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  fetchData(startDate, endDate);
}

function aggregateDataForPivot(summary) {
    const aggregated = {
        'SYSTEMì‚¬ì—…ë¶€': { total: 0, evacuated: 0, remaining: 0 },
        'INFRAì‚¬ì—…ë¶€': { total: 0, evacuated: 0, remaining: 0 },
        'ê²½ì˜ì§€ì›ì‹¤': { total: 0, evacuated: 0, remaining: 0 },
        'ì§ì†(ì—°êµ¬ì†Œ, êµ¬ë§¤íŒ€, ì•ˆì „í™˜ê²½, ê¸€ë¡œë²ŒTF)': { total: 0, evacuated: 0, remaining: 0 },
        'í˜‘ë ¥ì‚¬': { total: 0, evacuated: 0, remaining: 0 },
        'ê¸°íƒ€': { total: 0, evacuated: 0, remaining: 0 }
    };
    
    const visitorData = {
      total: 0, evacuated: 0, remaining: 0
    };

    summary.forEach(row => {
        const division = row.division;
        
        // ë‚´ë°©ê° ë°ì´í„°ëŠ” ë³„ë„ë¡œ ì§‘ê³„
        if (row.hasVisitor) {
            visitorData.total += row.visitorTotal;
            visitorData.evacuated += row.visitorEvacuated;
            visitorData.remaining += row.visitorRemaining;
        }

        // ì„ì§ì›, í˜‘ë ¥ì‚¬, ê¸°íƒ€ ë°ì´í„° ì§‘ê³„
        if (aggregated[division]) {
            aggregated[division].total += row.total;
            aggregated[division].evacuated += row.evacuated;
            aggregated[division].remaining += row.remaining;
        }
    });

    return { aggregated, visitorData };
}

function renderPivotTable(data) {
    const tbody = document.getElementById("pivotTableBody");
    tbody.innerHTML = '';
    
    const { aggregated, visitorData } = data;
    
    let grandTotalTotal = 0;
    let grandTotalEvacuated = 0;
    let grandTotalRemaining = 0;
    
    const orderedDivisions = ['SYSTEMì‚¬ì—…ë¶€', 'INFRAì‚¬ì—…ë¶€', 'ê²½ì˜ì§€ì›ì‹¤', 'ì§ì†(ì—°êµ¬ì†Œ, êµ¬ë§¤íŒ€, ì•ˆì „í™˜ê²½, ê¸€ë¡œë²ŒTF)', 'í˜‘ë ¥ì‚¬', 'ê¸°íƒ€'];
    
    orderedDivisions.forEach(division => {
        const rowData = aggregated[division];
        const row = document.createElement("tr");
        
        let visitorCells = '';
        if (division === orderedDivisions[0]) {
            visitorCells = `<td rowspan="${orderedDivisions.length}">${visitorData.total}</td><td rowspan="${orderedDivisions.length}">${visitorData.evacuated}</td><td rowspan="${orderedDivisions.length}">${visitorData.remaining}</td>`;
        }

        row.innerHTML = `
            <td>${division}</td>
            <td>${rowData.total}</td>
            <td>${rowData.evacuated}</td>
            <td>${rowData.remaining}</td>
            ${visitorCells}
        `;
        tbody.appendChild(row);

        grandTotalTotal += rowData.total;
        grandTotalEvacuated += rowData.evacuated;
        grandTotalRemaining += rowData.remaining;
    });

    document.getElementById("grandTotalTotal").textContent = grandTotalTotal;
    document.getElementById("grandTotalEvacuated").textContent = grandTotalEvacuated;
    document.getElementById("grandTotalRemaining").textContent = grandTotalRemaining;
    document.getElementById("grandTotalVisitorTotal").textContent = visitorData.total;
    document.getElementById("grandTotalVisitorEvacuated").textContent = visitorData.evacuated;
    document.getElementById("grandTotalVisitorRemaining").textContent = visitorData.remaining;
}

function renderAccordion(summary = []) {
  const container = document.getElementById("accordionContainer");
  container.innerHTML = "";

  for (const division in departments) {
    const item = document.createElement("div");
    item.className = "accordion-item";

    const header = document.createElement("div");
    header.className = "accordion-header";
    header.textContent = division;

    const content = document.createElement("div");
    content.className = "accordion-content";

    const subDepartments = departments[division];
    subDepartments.forEach(deptName => {
      const report = summary.find(row => row.department === deptName && row.division === division);
      
      const statusIcon = report ? (report.remaining === 0 ? "âœ”" : "âš ") : "âš ";
      const statusClass = report ? (report.remaining === 0 ? "ok" : "warn") : "pending";
      
      const deptRow = document.createElement("div");
      deptRow.className = "dept-row";
      deptRow.innerHTML = `
        <span class="dept-name">${deptName}</span>
        <span class="status ${statusClass}">${statusIcon}</span>
      `;
      deptRow.onclick = () => showPopup(report);
      content.appendChild(deptRow);
    });

    header.addEventListener('click', () => {
      const allContents = document.querySelectorAll('.accordion-content');
      allContents.forEach(c => {
        if (c !== content) { c.classList.remove('active'); }
      });
      content.classList.toggle('active');
    });

    item.appendChild(header);
    item.appendChild(content);
    container.appendChild(item);
  }
}

function showPopup(report) {
  const popup = document.getElementById("reportPopup");
  const title = document.getElementById("popupTitle");
  const totalInput = document.getElementById("popupTotal");
  const evacuatedInput = document.getElementById("popupEvacuated");
  const remainingInput = document.getElementById("popupRemaining");
  const notesTextarea = document.getElementById("popupNotes");
  const hasVisitorCheckbox = document.getElementById("popupHasVisitor");
  const visitorFieldsDiv = document.getElementById("visitorFields");
  const visitorTotalInput = document.getElementById("popupVisitorTotal");
  const visitorEvacuatedInput = document.getElementById("popupVisitorEvacuated");
  const visitorRemainingInput = document.getElementById("popupVisitorRemaining");
  const saveBtn = document.getElementById("saveBtn");

  if (report) {
    currentReportData = report;
    title.textContent = `${report.division} > ${report.department} ë³´ê³  ë‚´ì—­`;
    totalInput.value = report.total || 0;
    evacuatedInput.value = report.evacuated || 0;
    remainingInput.value = report.remaining || 0;
    notesTextarea.value = report.note || '';

    const hasVisitor = report.hasVisitor === true || report.hasVisitor === 'TRUE';
    hasVisitorCheckbox.checked = hasVisitor;
    visitorFieldsDiv.style.display = hasVisitor ? 'block' : 'none';
    visitorTotalInput.value = report.visitorTotal || 0;
    visitorEvacuatedInput.value = report.visitorEvacuated || 0;
    visitorRemainingInput.value = report.visitorRemaining || 0;
    
    saveBtn.textContent = 'ìˆ˜ì •';
  } else {
    currentReportData = { division: 'ë¯¸ë³´ê³ ', department: 'ë¯¸ë³´ê³ ' };
    title.textContent = `ë¯¸ë³´ê³  ë¶€ì„œ`;
    totalInput.value = '';
    evacuatedInput.value = '';
    remainingInput.value = '';
    notesTextarea.value = '';
    hasVisitorCheckbox.checked = false;
    visitorFieldsDiv.style.display = 'none';
    visitorTotalInput.value = '';
    visitorEvacuatedInput.value = '';
    visitorRemainingInput.value = '';
    saveBtn.textContent = 'ì‹ ê·œ ë³´ê³ ';
  }
  popup.style.display = 'flex';
  calculateAllRemaining();
}

function closePopup() {
  document.getElementById("reportPopup").style.display = 'none';
}

async function saveReport() {
  const total = parseInt(document.getElementById("popupTotal").value) || 0;
  const evacuated = parseInt(document.getElementById("popupEvacuated").value) || 0;
  const notes = document.getElementById("popupNotes").value;
  const remaining = total - evacuated;
  if (remaining < 0) {
    alert("ë¯¸ëŒ€í”¼ ì¸ì›ì€ ìŒìˆ˜ì¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  
  const hasVisitor = document.getElementById("popupHasVisitor").checked;
  const visitorTotal = hasVisitor ? parseInt(document.getElementById("popupVisitorTotal").value) || 0 : 0;
  const visitorEvacuated = hasVisitor ? parseInt(document.getElementById("popupVisitorEvacuated").value) || 0 : 0;
  const visitorRemaining = visitorTotal - visitorEvacuated;
  if (visitorRemaining < 0) {
    alert("ë‚´ë°©ê° ë¯¸ëŒ€í”¼ ì¸ì›ì€ ìŒìˆ˜ì¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const dataToSave = {
    division: currentReportData.division,
    department: currentReportData.department,
    total: total,
    evacuated: evacuated,
    remaining: remaining,
    notes: notes,
    hasVisitor: hasVisitor,
    visitorTotal: visitorTotal,
    visitorEvacuated: visitorEvacuated,
    visitorRemaining: visitorRemaining
  };

  try {
    const res = await fetch(`${WEBAPP_URL}?action=updateReport`, {
      method: 'POST',
      body: JSON.stringify(dataToSave)
    });
    const result = await res.json();
    if (result.result === "success") {
      alert("ë³´ê³ ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      closePopup();
      fetchData();
    } else {
      alert("ë³´ê³  ì €ì¥ ì‹¤íŒ¨: " + result.message);
    }
  } catch (error) {
    console.error("Error saving report:", error);
    alert("ë³´ê³  ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
}

function syncData() {
  fetchData();
  alert("ëŒ€í”¼ í˜„í™©ì„ ë™ê¸°í™”í–ˆìŠµë‹ˆë‹¤.");
}

function calculateAllRemaining() {
  const total = parseInt(document.getElementById("popupTotal").value) || 0;
  const evacuated = parseInt(document.getElementById("popupEvacuated").value) || 0;
  const remaining = total - evacuated;
  document.getElementById("popupRemaining").value = remaining >= 0 ? remaining : '';

  const visitorTotal = parseInt(document.getElementById("popupVisitorTotal").value) || 0;
  const visitorEvacuated = parseInt(document.getElementById("popupVisitorEvacuated").value) || 0;
  const visitorRemaining = visitorTotal - visitorEvacuated;
  document.getElementById("popupVisitorRemaining").value = visitorRemaining >= 0 ? visitorRemaining : '';
}

document.getElementById("popupTotal").addEventListener('input', calculateAllRemaining);
document.getElementById("popupEvacuated").addEventListener('input', calculateAllRemaining);
document.getElementById("popupHasVisitor").addEventListener('change', () => {
    const visitorFieldsDiv = document.getElementById("visitorFields");
    visitorFieldsDiv.style.display = document.getElementById("popupHasVisitor").checked ? 'block' : 'none';
    calculateAllRemaining();
});
document.getElementById("popupVisitorTotal").addEventListener('input', calculateAllRemaining);
document.getElementById("popupVisitorEvacuated").addEventListener('input', calculateAllRemaining);
document.getElementById("saveBtn").addEventListener('click', saveReport);


document.addEventListener('DOMContentLoaded', () => {
  fetchData();
  setInterval(fetchData, 30000);
});
</script>
</body>
</html>
