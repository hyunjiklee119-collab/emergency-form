<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ëª¨ë°”ì¼ ëŒ€í”¼ í˜„í™©íŒ</title>
<style>
Â  body {
Â  Â  font-family: 'Segoe UI', sans-serif;
Â  Â  background: #f8f9fa;
Â  Â  margin: 0;
Â  Â  padding: 10px;
Â  Â  color: #333;
Â  }
Â  .summary-table {
Â  Â  width: 100%;
Â  Â  border-collapse: collapse;
Â  Â  margin-bottom: 12px;
Â  Â  background: #fff;
Â  Â  border-radius: 10px;
Â  Â  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
Â  Â  overflow: hidden;
Â  }
Â  .summary-table th, .summary-table td {
Â  Â  padding: 10px 5px;
Â  Â  text-align: center;
Â  Â  border-bottom: 1px solid #eee;
Â  }
Â  .summary-table th {
Â  Â  background: #e9ecef;
Â  Â  font-size: 0.85rem;
Â  Â  font-weight: bold;
Â  Â  color: #495057;
Â  }
Â  .summary-table td {
Â  Â  font-size: 1.1rem;
Â  Â  font-weight: bold;
Â  }
Â  .summary-table tr:last-child td {
Â  Â  border-bottom: none;
Â  }
Â  .accordion-container {
Â  Â  background: #fff;
Â  Â  border-radius: 10px;
Â  Â  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
Â  Â  overflow: hidden;
Â  }
Â  .accordion-item {
Â  Â  border-bottom: 1px solid #eee;
Â  }
Â  .accordion-item:last-child {
Â  Â  border-bottom: none;
Â  }
Â  .accordion-header {
Â  Â  display: flex;
Â  Â  justify-content: space-between;
Â  Â  align-items: center;
Â  Â  padding: 12px 15px;
Â  Â  cursor: pointer;
Â  Â  background: #f4f4f4;
Â  Â  font-weight: bold;
Â  Â  font-size: 1rem;
Â  }
Â  .accordion-content {
Â  Â  display: none;
Â  Â  padding: 0 15px;
Â  Â  max-height: 0;
Â  Â  overflow: hidden;
Â  Â  transition: max-height 0.3s ease-out, padding 0.3s ease-out;
Â  }
Â  .accordion-content.active {
Â  Â  display: block;
Â  Â  max-height: 500px;
Â  Â  padding: 10px 15px;
Â  }
Â  .dept-row {
Â  Â  display: flex;
Â  Â  justify-content: space-between;
Â  Â  align-items: center;
Â  Â  padding: 6px 0;
Â  Â  cursor: pointer;
Â  }
Â  .dept-name { font-size: 0.9rem; }
Â  .status {
Â  Â  font-weight: bold;
Â  Â  font-size: 1rem;
Â  }
Â  .ok { color: #28a745; }
Â  .warn { color: #dc3545; }
Â  .pending { color: #ffc107; }

Â  .footer {
Â  Â  text-align: center;
Â  Â  margin-top: 12px;
Â  }
Â  button {
Â  Â  padding: 10px 20px;
Â  Â  font-size: 1rem;
Â  Â  border: none;
Â  Â  border-radius: 8px;
Â  Â  background: #007bff;
Â  Â  color: #fff;
Â  Â  box-shadow: 0 2px 4px rgba(0,0,0,0.15);
Â  Â  cursor: pointer;
Â  }
Â  button:active { background: #0056b3; }
Â  #lastUpdated {
Â  Â  text-align: center;
Â  Â  font-size: 0.75rem;
Â  Â  color: #777;
Â  Â  margin-top: 5px;
Â  }

Â  /* íŒì—… ìŠ¤íƒ€ì¼ */
Â  .popup {
Â  Â  display: none;
Â  Â  position: fixed;
Â  Â  left: 0;
Â  Â  top: 0;
Â  Â  width: 100%;
Â  Â  height: 100%;
Â  Â  background-color: rgba(0, 0, 0, 0.5);
Â  Â  justify-content: center;
Â  Â  align-items: center;
Â  Â  z-index: 1000;
Â  }
Â  .popup-content {
Â  Â  background: #fff;
Â  Â  padding: 20px;
Â  Â  border-radius: 10px;
Â  Â  width: 90%;
Â  Â  max-width: 400px;
Â  Â  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
Â  }
Â  .popup-content h3 {
Â  Â  margin-top: 0;
Â  Â  border-bottom: 2px solid #007bff;
Â  Â  padding-bottom: 10px;
Â  }
Â  .popup-content .input-group {
Â  Â  margin-bottom: 15px;
Â  }
Â  .popup-content label {
Â  Â  display: block;
Â  Â  font-size: 0.9rem;
Â  Â  color: #555;
Â  Â  margin-bottom: 5px;
Â  }
Â  .popup-content input, .popup-content textarea {
Â  Â  width: calc(100% - 20px);
Â  Â  padding: 8px 10px;
Â  Â  border: 1px solid #ccc;
Â  Â  border-radius: 5px;
Â  }
Â  .popup-content button {
Â  Â  width: 100%;
Â  Â  margin-top: 10px;
Â  }
Â  .popup-content .close-btn {
Â  Â  background: #6c757d;
Â  }
</style>
</head>
<body>

<table class="summary-table">
Â  <thead>
Â  Â  <tr>
Â  Â  Â  <th>êµ¬ë¶„</th>
Â  Â  Â  <th>ì´ ì¸ì›</th>
Â  Â  Â  <th>ëŒ€í”¼ì™„ë£Œ</th>
Â  Â  Â  <th>ë¯¸ëŒ€í”¼</th>
Â  Â  </tr>
Â  </thead>
Â  <tbody>
Â  Â  <tr>
Â  Â  Â  <td>ì„ì§ì›</td>
Â  Â  Â  <td id="employeeTotal">-</td>
Â  Â  Â  <td id="employeeEvacuated">-</td>
Â  Â  Â  <td id="employeeRemaining">-</td>
Â  Â  </tr>
Â  Â  <tr>
Â  Â  Â  <td>í˜‘ë ¥ì‚¬</td>
Â  Â  Â  <td id="partnerTotal">-</td>
Â  Â  Â  <td id="partnerEvacuated">-</td>
Â  Â  Â  <td id="partnerRemaining">-</td>
Â  Â  </tr>
Â  Â  <tr>
Â  Â  Â  <td>ë‚´ë°©ê°</td>
Â  Â  Â  <td id="visitorTotal">-</td>
Â  Â  Â  <td id="visitorEvacuated">-</td>
Â  Â  Â  <td id="visitorRemaining">-</td>
Â  Â  </tr>
Â  </tbody>
</table>

<div class="accordion-container" id="accordionContainer">
</div>

<div class="footer">
Â  <button onclick="syncData()">ğŸ”„ ë™ê¸°í™”</button>
Â  <p id="lastUpdated">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: -</p>
</div>

<div id="reportPopup" class="popup">
Â  <div class="popup-content">
Â  Â  <h3 id="popupTitle"></h3>
Â  Â  <div class="input-group">
Â  Â  Â  <label for="popupTotal">ì´ ì¸ì›</label>
Â  Â  Â  <input type="number" id="popupTotal">
Â  Â  </div>
Â  Â  <div class="input-group">
Â  Â  Â  <label for="popupEvacuated">ëŒ€í”¼ì™„ë£Œ</label>
Â  Â  Â  <input type="number" id="popupEvacuated">
Â  Â  </div>
Â  Â  <div class="input-group">
Â  Â  Â  <label for="popupRemaining">ë¯¸ëŒ€í”¼</label>
Â  Â  Â  <input type="number" id="popupRemaining" disabled>
Â  Â  </div>
Â  Â  <div class="input-group">
Â  Â  Â  <label for="popupNotes">íŠ¹ì´ì‚¬í•­</label>
Â  Â  Â  <textarea id="popupNotes"></textarea>
Â  Â  </div>
Â  Â  <button id="saveBtn">ì €ì¥</button>
Â  Â  <button class="close-btn" onclick="closePopup()">ë‹«ê¸°</button>
Â  </div>
</div>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwx3zhwNBTmXKTw58yo6bfvlXFY5TRLCCPnjcJ_vAd9qFlwxyklm6awOSNvQx0zx_B0/exec";
let currentReportData = null;

const departments = {
Â  Â  'SYSTEMì‚¬ì—…ë¶€': ['ì‚¬ì—…ë¶€ ê³µí†µ', 'ì˜ì—…íŒ€', 'CSíŒ€', 'ì œì¡°íŒ€', 'ìƒì‚°ê¸°ìˆ íŒ€', 'í’ˆì§ˆG'],
Â  Â  'INFRAì‚¬ì—…ë¶€': ['ì‚¬ì—…ë¶€ ê³µí†µ', 'ENCì‚¬ì—…íŒ€', 'EPCì‚¬ì—…íŒ€'],
Â  Â  'ê²½ì˜ì§€ì›ì‹¤': ['ì‚¬ì—…ë¶€ ê³µí†µ', 'ì¬ë¬´íŒ€', 'ì¸ì‚¬íŒ€', 'ì •ë³´ì „ëµíŒ€', 'ê¸°íšG', 'ì¤€ë²•ê²½ì˜G'],
Â  Â  'ì§ì†(ì—°êµ¬ì†Œ, êµ¬ë§¤íŒ€, ì•ˆì „í™˜ê²½, ê¸€ë¡œë²ŒTF)': ['ì‚¬ì—…ë¶€ ê³µí†µ', 'ì—°êµ¬ì†Œ', 'êµ¬ë§¤íŒ€', 'ì•ˆì „í™˜ê²½íŒ€', 'ê¸€ë¡œë²ŒTF'],
};

async function fetchData() {
Â  try {
Â  Â  const res = await fetch(`${WEBAPP_URL}?action=getSummary`);
Â  Â  const data = await res.json();
Â  Â  if (data.result === "success") {
Â  Â  Â  const summary = data.summary || [];
Â  Â  Â Â 
Â  Â  Â  const employeeData = summary.filter(row => row.division !== 'í˜‘ë ¥ì‚¬' && row.division !== 'ê¸°íƒ€');
Â  Â  Â  const partnerData = summary.filter(row => row.division === 'í˜‘ë ¥ì‚¬');
Â  Â  Â  const visitorData = summary.filter(row => row.division === 'ê¸°íƒ€');

Â  Â  Â  const employeeTotal = employeeData.reduce((sum, row) => sum + (row.total || 0), 0);
Â  Â  Â  const employeeEvacuated = employeeData.reduce((sum, row) => sum + (row.evacuated || 0), 0);
Â  Â  Â  const employeeRemaining = employeeData.reduce((sum, row) => sum + (row.remaining || 0), 0);
Â  Â  Â Â 
Â  Â  Â  const partnerTotal = partnerData.reduce((sum, row) => sum + (row.total || 0), 0);
Â  Â  Â  const partnerEvacuated = partnerData.reduce((sum, row) => sum + (row.evacuated || 0), 0);
Â  Â  Â  const partnerRemaining = partnerData.reduce((sum, row) => sum + (row.remaining || 0), 0);
Â  Â  Â Â 
Â  Â  Â  const visitorTotal = visitorData.reduce((sum, row) => sum + (row.total || 0), 0);
Â  Â  Â  const visitorEvacuated = visitorData.reduce((sum, row) => sum + (row.evacuated || 0), 0);
Â  Â  Â  const visitorRemaining = visitorData.reduce((sum, row) => sum + (row.remaining || 0), 0);

Â  Â  Â  document.getElementById("employeeTotal").textContent = employeeTotal;
Â  Â  Â  document.getElementById("employeeEvacuated").textContent = employeeEvacuated;
Â  Â  Â  document.getElementById("employeeRemaining").textContent = employeeRemaining;
Â  Â  Â Â 
Â  Â  Â  document.getElementById("partnerTotal").textContent = partnerTotal;
Â  Â  Â  document.getElementById("partnerEvacuated").textContent = partnerEvacuated;
Â  Â  Â  document.getElementById("partnerRemaining").textContent = partnerRemaining;
Â  Â  Â Â 
Â  Â  Â  document.getElementById("visitorTotal").textContent = visitorTotal;
Â  Â  Â  document.getElementById("visitorEvacuated").textContent = visitorEvacuated;
Â  Â  Â  document.getElementById("visitorRemaining").textContent = visitorRemaining;

Â  Â  Â  renderAccordion(summary);
Â  Â  }
Â  } catch (error) {
Â  Â  console.error("Error fetching data:", error);
Â  Â  renderAccordion([]);
Â  }
Â  document.getElementById("lastUpdated").textContent = "ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: " + new Date().toLocaleTimeString();
}

function renderAccordion(summary = []) {
Â  const container = document.getElementById("accordionContainer");
Â  container.innerHTML = "";

Â  for (const division in departments) {
Â  Â  const item = document.createElement("div");
Â  Â  item.className = "accordion-item";

Â  Â  const header = document.createElement("div");
Â  Â  header.className = "accordion-header";
Â  Â  header.textContent = division;

Â  Â  const content = document.createElement("div");
Â  Â  content.className = "accordion-content";

Â  Â  const subDepartments = departments[division];
Â  Â  subDepartments.forEach(deptName => {
Â  Â  Â  const report = summary.find(row => row.department === deptName && row.division === division);
Â  Â  Â Â 
Â  Â  Â  const statusIcon = report ? (report.remaining === 0 ? "âœ”" : "âš ") : "âš ";
Â  Â  Â  const statusClass = report ? (report.remaining === 0 ? "ok" : "warn") : "pending";
Â  Â  Â Â 
Â  Â  Â  const deptRow = document.createElement("div");
Â  Â  Â  deptRow.className = "dept-row";
Â  Â  Â  deptRow.innerHTML = `
Â  Â  Â  Â  <span class="dept-name">${deptName}</span>
Â  Â  Â  Â  <span class="status ${statusClass}">${statusIcon}</span>
Â  Â  Â  `;
Â  Â  Â  deptRow.onclick = () => showPopup(report);
Â  Â  Â  content.appendChild(deptRow);
Â  Â  });

Â  Â  header.addEventListener('click', () => {
Â  Â  Â  const allContents = document.querySelectorAll('.accordion-content');
Â  Â  Â  allContents.forEach(c => {
Â  Â  Â  Â  if (c !== content) {
Â  Â  Â  Â  Â  c.classList.remove('active');
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â  content.classList.toggle('active');
Â  Â  });

Â  Â  item.appendChild(header);
Â  Â  item.appendChild(content);
Â  Â  container.appendChild(item);
Â  }
}

function showPopup(report) {
Â  const popup = document.getElementById("reportPopup");
Â  const title = document.getElementById("popupTitle");
Â  const totalInput = document.getElementById("popupTotal");
Â  const evacuatedInput = document.getElementById("popupEvacuated");
Â  const remainingInput = document.getElementById("popupRemaining");
Â  const notesTextarea = document.getElementById("popupNotes");
Â  const saveBtn = document.getElementById("saveBtn");

Â  if (report) {
Â  Â  currentReportData = report;
Â  Â  title.textContent = `${report.division} > ${report.department} ë³´ê³  ë‚´ì—­`;
Â  Â  totalInput.value = report.total || 0;
Â  Â  evacuatedInput.value = report.evacuated || 0;
Â  Â  remainingInput.value = report.remaining || 0;
Â  Â  notesTextarea.value = report.notes || '';
Â  Â  saveBtn.textContent = 'ìˆ˜ì •';
Â  } else {
Â  Â  currentReportData = { division: 'ë¯¸ë³´ê³ ', department: 'ë¯¸ë³´ê³ ' };
Â  Â  title.textContent = `ë¯¸ë³´ê³  ë¶€ì„œ`;
Â  Â  totalInput.value = '';
Â  Â  evacuatedInput.value = '';
Â  Â  remainingInput.value = '';
Â  Â  notesTextarea.value = '';
Â  Â  saveBtn.textContent = 'ì‹ ê·œ ë³´ê³ ';
Â  }
Â  popup.style.display = 'flex';
}

function closePopup() {
Â  document.getElementById("reportPopup").style.display = 'none';
}

async function saveReport() {
Â  const total = parseInt(document.getElementById("popupTotal").value) || 0;
Â  const evacuated = parseInt(document.getElementById("popupEvacuated").value) || 0;
Â  const notes = document.getElementById("popupNotes").value;
Â  const remaining = total - evacuated;
Â  if (remaining < 0) {
Â  Â  alert("ë¯¸ëŒ€í”¼ ì¸ì›ì€ ìŒìˆ˜ì¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
Â  Â  return;
Â  }
Â 
Â  const dataToSave = {
Â  Â  division: currentReportData.division,
Â  Â  department: currentReportData.department,
Â  Â  total: total,
Â  Â  evacuated: evacuated,
Â  Â  remaining: remaining,
Â  Â  notes: notes,
Â  };

Â  try {
Â  Â  const res = await fetch(`${WEBAPP_URL}?action=updateReport`, {
Â  Â  Â  method: 'POST',
Â  Â  Â  body: JSON.stringify(dataToSave)
Â  Â  });
Â  Â  const result = await res.json();
Â  Â  if (result.result === "success") {
Â  Â  Â  alert("ë³´ê³ ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
Â  Â  Â  closePopup();
Â  Â  Â  fetchData();
Â  Â  } else {
Â  Â  Â  alert("ë³´ê³  ì €ì¥ ì‹¤íŒ¨: " + result.message);
Â  Â  }
Â  } catch (error) {
Â  Â  console.error("Error saving report:", error);
Â  Â  alert("ë³´ê³  ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
Â  }
}

function syncData() {
Â  fetchData();
Â  alert("ëŒ€í”¼ í˜„í™©ì„ ë™ê¸°í™”í–ˆìŠµë‹ˆë‹¤.");
}

document.getElementById("popupTotal").addEventListener('input', calculateRemaining);
document.getElementById("popupEvacuated").addEventListener('input', calculateRemaining);
document.getElementById("saveBtn").addEventListener('click', saveReport);

function calculateRemaining() {
Â  const total = parseInt(document.getElementById("popupTotal").value) || 0;
Â  const evacuated = parseInt(document.getElementById("popupEvacuated").value) || 0;
Â  const remaining = total - evacuated;
Â  document.getElementById("popupRemaining").value = remaining >= 0 ? remaining : '';
}

fetchData();
setInterval(fetchData, 30000);
</script>
</body>
</html>
