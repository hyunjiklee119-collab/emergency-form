<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>비상대피 현황 대시보드</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .dashboard-container { max-width: 900px; margin: 0 auto; display: grid; gap: 20px; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        .score-card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center; }
        .score-card h3 { color: #1a237e; margin: 0 0 10px 0; font-size: 1rem; }
        .score-card .value { font-size: 2.5rem; font-weight: bold; color: #007bff; }
        #lastUpdated { font-size: 0.8rem; color: #888; margin-top: 20px; text-align: center; }
        .loading { text-align: center; padding: 20px; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 2s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* 새로 추가된 스타일 */
        .data-table-container { max-width: 900px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .filter-container { display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 15px; }
        .filter-container input[type="date"] { padding: 8px; border: 1px solid #ccc; border-radius: 6px; }
        .filter-container button { padding: 8px 15px; border: none; background: #007bff; color: #fff; border-radius: 6px; cursor: pointer; }
        .filter-container button:hover { background: #0056b3; }
        .report-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .report-table th, .report-table td { border: 1px solid #ddd; padding: 10px; text-align: left; font-size: 0.9rem; }
        .report-table th { background-color: #f2f2f2; font-weight: bold; }
        .report-table tbody tr:nth-child(even) { background-color: #f9f9f9; }
        .no-data { text-align: center; color: #888; padding: 20px; }
    </style>
</head>
<body>

<div class="dashboard-container" id="dashboard">
    <div class="score-card">
        <h3>총 대피대상자</h3>
        <p class="value" id="totalCount">-</p>
    </div>
    <div class="score-card">
        <h3>대피완료 인원</h3>
        <p class="value" id="evacuatedCount">-</p>
    </div>
    <div class="score-card">
        <h3>미대피 인원</h3>
        <p class="value" id="remainingCount">-</p>
    </div>
    <div class="score-card">
        <h3>내방객 인원</h3>
        <p class="value" id="visitorCount">-</p>
    </div>
</div>
<div id="lastUpdated"></div>
<div class="loading" id="loadingMessage">
    <div class="loader"></div>
    <p>데이터를 불러오는 중...</p>
</div>

<div class="data-table-container">
    <div class="filter-container">
        <label for="startDate">시작일:</label>
        <input type="date" id="startDate">
        <label for="endDate">종료일:</label>
        <input type="date" id="endDate">
        <button onclick="fetchFilteredData()">조회</button>
    </div>
    <table class="report-table">
        <thead>
            <tr>
                <th>보고일시</th>
                <th>보고자</th>
                <th>소속</th>
                <th>대피완료</th>
                <th>미대피</th>
                <th>특이사항</th>
            </tr>
        </thead>
        <tbody id="reportTableBody">
            </tbody>
    </table>
    <div id="noDataMessage" class="no-data" style="display:none;">
        해당 기간에 보고된 데이터가 없습니다.
    </div>
</div>

<script>
    // 이 URL은 `code.gs`의 GET 요청을 처리할 웹 앱 URL로 변경하세요.
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbysncTbZ4pE6A4o4acDRaJ3SXXzWE5SwmkIUd3-Vzc-TB7tvNTomUs6fSpEYFLLiWks/exec";
    
    // ... (기존 변수 선언) ...
    const reportTableBody = document.getElementById("reportTableBody");
    const noDataMessage = document.getElementById("noDataMessage");
    const startDateInput = document.getElementById("startDate");
    const endDateInput = document.getElementById("endDate");

    // 오늘 날짜로 필터 기본값 설정
    const today = new Date().toISOString().slice(0, 10);
    startDateInput.value = today;
    endDateInput.value = today;

    // ... (기존 fetchData 함수) ...
    async function fetchData() {
        loadingMessageEl.style.display = 'block';
        dashboardContainer.style.display = 'none';
        try {
            const response = await fetch(WEBAPP_URL);
            const result = await response.json();
            
            if (result.result === "success") {
                const data = result.data;
                totalCountEl.textContent = data.total;
                evacuatedCountEl.textContent = data.evacuated;
                remainingCountEl.textContent = data.remaining;
                visitorCountEl.textContent = data.visitorTotal;
                lastUpdatedEl.textContent = `마지막 업데이트: ${new Date().toLocaleTimeString()}`;
            } else {
                console.error("API 오류:", result.error);
                totalCountEl.textContent = "에러";
            }
        } catch (error) {
            console.error("데이터 로딩 실패:", error);
            totalCountEl.textContent = "연결 오류";
        } finally {
            loadingMessageEl.style.display = 'none';
            dashboardContainer.style.display = 'grid';
        }
    }

    // 필터링된 데이터를 가져오는 함수
    async function fetchFilteredData() {
        reportTableBody.innerHTML = '';
        noDataMessage.style.display = 'none';

        const startDate = startDateInput.value;
        const endDate = endDateInput.value;

        try {
            const response = await fetch(`${WEBAPP_URL}?action=getReports&startDate=${startDate}&endDate=${endDate}`);
            const result = await response.json();

            if (result.result === "success") {
                if (result.reports.length > 0) {
                    result.reports.forEach(report => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${report.date}</td>
                            <td>${report.reporter}</td>
                            <td>${report.division} / ${report.department}</td>
                            <td>${report.evacuated}</td>
                            <td>${report.remaining}</td>
                            <td>${report.note || ''}</td>
                        `;
                        reportTableBody.appendChild(row);
                    });
                } else {
                    noDataMessage.style.display = 'block';
                }
            } else {
                console.error("API 오류:", result.error);
                noDataMessage.textContent = "데이터를 불러오는 중 오류가 발생했습니다.";
                noDataMessage.style.display = 'block';
            }
        } catch (error) {
            console.error("데이터 로딩 실패:", error);
            noDataMessage.textContent = "네트워크 연결 오류입니다.";
            noDataMessage.style.display = 'block';
        }
    }

    // 페이지 로드 시 즉시 실행
    fetchData();
    fetchFilteredData();
    setInterval(fetchData, 10000); // 10초마다 스코어 카드만 새로고침

</script>

</body>
</html>
