<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ëª¨ë°”ì¼ ëŒ€í”¼ í˜„í™©íŒ</title>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background: #f8f9fa;
    margin: 0;
    padding: 10px;
    color: #333;
  }
  .summary-table, .visitor-summary-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 12px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    overflow: hidden;
  }
  .summary-table th, .summary-table td, .visitor-summary-table th, .visitor-summary-table td {
    padding: 8px 3px;
    text-align: center;
    border: 1px solid #eee;
  }
  .summary-table th, .visitor-summary-table th {
    background: #e9ecef;
    font-size: 0.75rem;
    font-weight: bold;
    color: #495057;
  }
  .summary-table td, .visitor-summary-table td {
    font-size: 0.85rem;
    font-weight: bold;
  }
  .summary-table .total-row, .visitor-summary-table .total-row {
    font-weight: bold;
    background: #f1f1f1;
  }
  .filter-controls {
    text-align: center;
    margin-bottom: 15px;
  }
  #currentDate {
    font-weight: bold;
    font-size: 1.1rem;
    color: #0056b3;
  }
  .accordion-container {
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    overflow: hidden;
  }
  .accordion-item {
    border-bottom: 1px solid #eee;
  }
  .accordion-item:last-child {
    border-bottom: none;
  }
  .accordion-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    cursor: pointer;
    background: #f4f4f4;
    font-weight: bold;
    font-size: 1rem;
  }
  .accordion-content {
    display: none;
    padding: 0 15px;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out, padding 0.3s ease-out;
  }
  .accordion-content.active {
    display: block;
    max-height: 500px;
    padding: 10px 15px;
  }
  .dept-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    cursor: pointer;
  }
  .dept-name { font-size: 0.9rem; }
  .status {
    font-weight: bold;
    font-size: 1rem;
    width: 20px;
    text-align: center;
  }
  .ok { color: #28a745; }
  .warn { color: #dc3545; }
  .note { color: #ffc107; }
  .pending { color: #888; }
  .status-legend {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 10px;
    font-size: 0.8rem;
    color: #555;
  }
  .legend-item {
    display: flex;
    align-items: center;
    margin: 0 8px;
  }
  .legend-icon {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 4px;
  }
  .ok-bg { background-color: #28a745; }
  .warn-bg { background-color: #dc3545; }
  .note-bg { background-color: #ffc107; }
  .pending-bg { background-color: #888; }
  .footer {
    text-align: center;
    margin-top: 12px;
  }
  button {
    padding: 10px 20px;
    font-size: 1rem;
    border: none;
    border-radius: 8px;
    background: #007bff;
    color: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    cursor: pointer;
  }
  button:disabled {
    background: #aaa;
    cursor: not-allowed;
  }
  button:active { background: #0056b3; }
  .footer-links {
    margin-top: 10px;
  }
  .footer-links a {
    color: #007bff;
    text-decoration: none;
    font-size: 0.8rem;
  }
  #lastUpdated {
    text-align: center;
    font-size: 0.75rem;
    color: #777;
    margin-top: 5px;
  }
  /* íŒì—… ìŠ¤íƒ€ì¼ */
  .popup {
    display: none;
    position: fixed;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  .popup-content {
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }
  .popup-content h3 {
    margin-top: 0;
    border-bottom: 2px solid #007bff;
    padding-bottom: 10px;
  }
  .popup-content .input-group {
    margin-bottom: 15px;
  }
  .popup-content label {
    display: block;
    font-size: 0.9rem;
    color: #555;
    margin-bottom: 5px;
  }
  .popup-content input, .popup-content textarea {
    width: calc(100% - 20px);
    padding: 8px 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
  }
  .popup-content .popup-btn {
    width: calc(50% - 5px);
    margin-top: 10px;
  }
  .popup-content .close-btn {
    background: #6c757d;
  }
  .popup-content .input-group.checkbox-group {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .popup-content .input-group.checkbox-group label {
    margin-bottom: 0;
  }
  .popup-content .input-group.checkbox-group input[type="checkbox"] {
    width: auto;
  }
  .recent-report-summary {
    background: #e9ecef;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 15px;
    font-size: 0.85rem;
  }
  #sync-status {
    font-size: 0.8rem;
    color: #007bff;
    margin-top: 5px;
    display: none;
  }
  #remaining-info, #visitor-remaining-info {
    font-size: 0.8rem;
    color: #777;
    margin-top: -10px;
    margin-bottom: 10px;
    font-weight: bold;
    padding-left: 2px;
  }
  .negative-warning {
    color: #dc3545;
    font-weight: bold;
  }
  #reportForm { display: none; }
  .report-log-container {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 15px;
  }
  .report-log-item {
    padding: 8px;
    border-bottom: 1px solid #eee;
    font-size: 0.8rem;
  }
  .report-log-item:last-child {
    border-bottom: none;
  }
</style>
</head>
<body>

<div class="filter-controls">
  <p id="currentDate">í˜„ì¬: <span id="displayDate"></span></p>
</div>

<table class="visitor-summary-table">
  <thead>
    <tr>
      <th colspan="3">ë‚´ë°©ê° Â· í˜‘ë ¥ì—…ì²´</th>
    </tr>
    <tr>
      <th>ì´ì›</th>
      <th>ëŒ€í”¼ì™„ë£Œ</th>
      <th>ë¯¸ëŒ€í”¼</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="grandTotalVisitorTotal">-</td>
      <td id="grandTotalVisitorEvacuated">-</td>
      <td id="grandTotalVisitorRemaining">-</td>
    </tr>
  </tbody>
</table>

<table class="summary-table">
  <thead>
    <tr>
      <th rowspan="2">êµ¬ë¶„</th>
      <th colspan="3">ì„ì§ì›</th>
    </tr>
    <tr>
      <th>ì´ì›</th>
      <th>ëŒ€í”¼ì™„ë£Œ</th>
      <th>ë¯¸ëŒ€í”¼</th>
    </tr>
  </thead>
  <tbody id="pivotTableBody">
  </tbody>
  <tfoot>
    <tr class="total-row">
      <td>ì´ê³„</td>
      <td id="grandTotalTotal">-</td>
      <td id="grandTotalEvacuated">-</td>
      <td id="grandTotalRemaining">-</td>
    </tr>
  </tfoot>
</table>

<div class="accordion-container" id="accordionContainer">
</div>

<div class="status-legend">
  <div class="legend-item"><span class="legend-icon ok-bg"></span> ì–‘í˜¸</div>
  <div class="legend-item"><span class="legend-icon note-bg"></span> í™•ì¸ í•„ìš”</div>
  <div class="legend-item"><span class="legend-icon warn-bg"></span> ë¯¸ëŒ€í”¼ ë°œìƒ</div>
  <div class="legend-item"><span class="legend-icon pending-bg"></span> ë¯¸ë³´ê³ </div>
</div>

<div class="footer">
  <button id="syncBtn">ğŸ”„ ë™ê¸°í™”</button>
  <p id="sync-status">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
  <p id="lastUpdated">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: -</p>
  <div class="footer-links">
    <a href="YOUR_GOOGLE_SHEET_URL" target="_blank">ì›ë³¸ êµ¬ê¸€ ì‹œíŠ¸ í™•ì¸</a>
  </div>
</div>

<div id="reportPopup" class="popup">
  <div class="popup-content">
    <h3 id="popupTitle"></h3>
    
    <div id="reportLogContainer" class="report-log-container"></div>
    
    <div style="text-align:center;">
      <button id="newReportBtn" style="margin-top: 10px;">ë³´ê³ í•˜ê¸°</button>
    </div>
    
    <div id="reportForm">
      <div class="input-group">
        <label for="popupTotal">ì´ ì¸ì›</label>
        <input type="number" id="popupTotal" placeholder="ì¸ì› ìˆ˜ ì…ë ¥">
      </div>
      <div class="input-group">
        <label for="popupEvacuated">ëŒ€í”¼ì™„ë£Œ</label>
        <input type="number" id="popupEvacuated" placeholder="ì¸ì› ìˆ˜ ì…ë ¥">
      </div>
      <div id="remaining-info"></div>
      
      <div class="input-group checkbox-group">
        <label for="popupHasVisitor">ë‚´ë°©ê° Â· í˜‘ë ¥ì—…ì²´ í¬í•¨</label>
        <input type="checkbox" id="popupHasVisitor">
      </div>
      <div id="visitorFields" style="display:none;">
        <div class="input-group">
          <label for="popupVisitorTotal">ë‚´ë°©ê° Â· í˜‘ë ¥ì—…ì²´ ì´ì›</label>
          <input type="number" id="popupVisitorTotal" min="0" placeholder="ì¸ì› ìˆ˜ ì…ë ¥">
        </div>
        <div class="input-group">
          <label for="popupVisitorEvacuated">ë‚´ë°©ê° Â· í˜‘ë ¥ì—…ì²´ ëŒ€í”¼ì™„ë£Œ</label>
          <input type="number" id="popupVisitorEvacuated" min="0" placeholder="ì¸ì› ìˆ˜ ì…ë ¥">
        </div>
        <div id="visitor-remaining-info"></div>
      </div>

      <div class="input-group">
        <label for="popupNotes">íŠ¹ì´ì‚¬í•­</label>
        <textarea id="popupNotes" placeholder="íŠ¹ì´ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
      </div>
      <button id="saveBtn" class="popup-btn">ì €ì¥</button>
    </div>
    <div style="text-align:right;">
      <button class="close-btn popup-btn" onclick="closePopup()">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyi307t8us1etL-I0P82NroRAcQAyjvi07v1NgqNAhUbzZDPLd3tZ_-ssGkzuXOVLl4/exec";
const GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/1fLIQijY7EtywKy-4ng3tvMm6ZstN7Ua2RKqH7RMxp1Q/edit?gid=0#gid=0";
let currentReportData = null;
let cumulativeReports = {};
let allReports = []; // ëª¨ë“  ë³´ê³ ì„œ ê¸°ë¡ì„ ì €ì¥í•  ì „ì—­ ë³€

// ë³€ê²½ëœ ë¶€ë¶„: 'í˜‘ë ¥ì‚¬'ì™€ 'ê¸°íƒ€' í•­ëª© ì‚­ì œ
const departments = {
  'SYSTEMì‚¬ì—…ë¶€': ['ì‚¬ì—…ë¶€ ê³µí†µ', 'ì˜ì—…íŒ€', 'CSíŒ€', 'ì œì¡°íŒ€', 'ìƒì‚°ê¸°ìˆ íŒ€', 'í’ˆì§ˆG'],
  'INFRAì‚¬ì—…ë¶€': ['ì‚¬ì—…ë¶€ ê³µí†µ', 'ENCì‚¬ì—…íŒ€', 'EPCì‚¬ì—…íŒ€'],
  'ê²½ì˜ì§€ì›ì‹¤': ['ì‚¬ì—…ë¶€ ê³µí†µ', 'ì¬ë¬´íŒ€', 'ì¸ì‚¬íŒ€', 'ì •ë³´ì „ëµíŒ€', 'ê¸°íšG', 'ì¤€ë²•ê²½ì˜G'],
  'ì§ì†(ì—°êµ¬ì†Œ, êµ¬ë§¤íŒ€, ì•ˆì „í™˜ê²½, ê¸€ë¡œë²ŒTF)': ['ì‚¬ì—…ë¶€ ê³µí†µ', 'ì—°êµ¬ì†Œ', 'êµ¬ë§¤íŒ€', 'ì•ˆì „í™˜ê²½íŒ€', 'ê¸€ë¡œë²ŒTF'],
};

document.getElementById('displayDate').textContent = new Date().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
document.querySelector('.footer-links a').href = GOOGLE_SHEET_URL;

async function fetchData() {
  const syncBtn = document.getElementById("syncBtn");
  const syncStatus = document.getElementById("sync-status");

  syncBtn.disabled = true;
  syncStatus.style.display = 'block';

  try {
    const res = await fetch(WEBAPP_URL);
    const data = await res.json();
    if (data.result === "success") {
      cumulativeReports = data.summary || [];
      allReports = data.allReports || []; // ëª¨ë“  ë³´ê³ ì„œ ê¸°ë¡ì„ ì €ì¥
      renderTables(cumulativeReports);
      renderAccordion(cumulativeReports);
    } else {
      console.error("API response failed:", data.error);
      alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + data.error);
    }
  } catch (error) {
    console.error("Error fetching data:", error);
    alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    renderTables([]);
    renderAccordion([]);
  } finally {
    syncStatus.style.display = 'none';
    syncBtn.disabled = false;
    document.getElementById("lastUpdated").textContent = "ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: " + new Date().toLocaleTimeString('ko-KR');
  }
}

function renderTables(summaryData) {
  const tbody = document.getElementById("pivotTableBody");
  tbody.innerHTML = '';
  
  let grandTotalTotal = 0;
  let grandTotalEvacuated = 0;
  let grandTotalRemaining = 0;
  
  let grandTotalVisitorTotal = 0;
  let grandTotalVisitorEvacuated = 0;
  let grandTotalVisitorRemaining = 0;

  // ë³€ê²½ëœ ë¶€ë¶„: 'í˜‘ë ¥ì‚¬'ì™€ 'ê¸°íƒ€' í•­ëª© ì‚­ì œ
  const orderedDivisions = ['SYSTEMì‚¬ì—…ë¶€', 'INFRAì‚¬ì—…ë¶€', 'ê²½ì˜ì§€ì›ì‹¤', 'ì§ì†(ì—°êµ¬ì†Œ, êµ¬ë§¤íŒ€, ì•ˆì „í™˜ê²½, ê¸€ë¡œë²ŒTF)'];
  
  const pivotData = {};
  orderedDivisions.forEach(div => {
    pivotData[div] = { total: 0, evacuated: 0, remaining: 0 };
  });

  summaryData.forEach(row => {
    const division = row.division;
    if (pivotData[division]) {
      pivotData[division].total += row.total;
      pivotData[division].evacuated += row.evacuated;
      pivotData[division].remaining += row.remaining;
    }
    grandTotalTotal += row.total;
    grandTotalEvacuated += row.evacuated;
    grandTotalRemaining += row.remaining;

    grandTotalVisitorTotal += row.visitorTotal;
    grandTotalVisitorEvacuated += row.visitorEvacuated;
    grandTotalVisitorRemaining += row.visitorRemaining;
  });

  orderedDivisions.forEach(division => {
    const rowData = pivotData[division];
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${division}</td>
      <td>${rowData.total}</td>
      <td>${rowData.evacuated}</td>
      <td>${rowData.remaining}</td>
    `;
    tbody.appendChild(row);
  });

  document.getElementById("grandTotalTotal").textContent = grandTotalTotal;
  document.getElementById("grandTotalEvacuated").textContent = grandTotalEvacuated;
  document.getElementById("grandTotalRemaining").textContent = grandTotalRemaining;

  document.getElementById("grandTotalVisitorTotal").textContent = grandTotalVisitorTotal;
  document.getElementById("grandTotalVisitorEvacuated").textContent = grandTotalVisitorEvacuated;
  document.getElementById("grandTotalVisitorRemaining").textContent = grandTotalVisitorRemaining;
}

function renderAccordion(summaryData) {
  const container = document.getElementById("accordionContainer");
  container.innerHTML = "";
  
  const departmentMap = new Map(summaryData.map(item => [`${item.division}-${item.department}`, item]));

  // ë³€ê²½ëœ ë¶€ë¶„: 'í˜‘ë ¥ì‚¬'ì™€ 'ê¸°íƒ€' í•­ëª© ì‚­ì œ
  for (const division in departments) {
    const item = document.createElement("div");
    item.className = "accordion-item";
    const header = document.createElement("div");
    header.className = "accordion-header";
    header.textContent = division;
    const content = document.createElement("div");
    content.className = "accordion-content";

    const subDepartments = departments[division];
    subDepartments.forEach(deptName => {
      const report = departmentMap.get(`${division}-${deptName}`);
      
      let statusIcon = 'âš«';
      let statusClass = 'pending';

      if (report) {
        const remainingAll = report.remaining + report.visitorRemaining;
        const hasNote = report.note && report.note.trim() !== '';

        if (hasNote) {
          statusIcon = 'ğŸŸ¡';
          statusClass = 'note';
        } else if (remainingAll > 0) {
          statusIcon = 'ğŸ”´';
          statusClass = 'warn';
        } else {
          statusIcon = 'ğŸŸ¢'; 
          statusClass = 'ok';
        }
      }
      
      const deptRow = document.createElement("div");
      deptRow.className = "dept-row";
      deptRow.innerHTML = `
        <span class="dept-name">${deptName}</span>
        <span class="status ${statusClass}">${statusIcon}</span>
      `;
      deptRow.onclick = () => showPopup(division, deptName);
      content.appendChild(deptRow);
    });

    header.addEventListener('click', () => {
      const allContents = document.querySelectorAll('.accordion-content');
      allContents.forEach(c => {
        if (c !== content) { c.classList.remove('active'); }
      });
      content.classList.toggle('active');
    });

    item.appendChild(header);
    item.appendChild(content);
    container.appendChild(item);
  }
}

function showPopup(division, department) {
  const popup = document.getElementById("reportPopup");
  const title = document.getElementById("popupTitle");
  const reportForm = document.getElementById("reportForm");
  
  currentReportData = { division, department };
  title.textContent = `${division} > ${department} ë³´ê³ `;
  reportForm.style.display = 'block';

  // íŒì—…ì´ ì—´ë¦´ ë•Œ ë³´ê³ ì„œ ë¡œê·¸ë¥¼ ë Œë”ë§
  renderReportLog(division, department);

  // í¼ ì´ˆê¸°í™”
  document.getElementById("popupTotal").value = '';
  document.getElementById("popupEvacuated").value = '';
  document.getElementById("popupNotes").value = '';
  document.getElementById("popupHasVisitor").checked = false;
  document.getElementById("visitorFields").style.display = 'none';
  document.getElementById("popupVisitorTotal").value = '';
  document.getElementById("popupVisitorEvacuated").value = '';
  
  document.getElementById("popupTotal").disabled = false;
  document.getElementById("popupVisitorTotal").disabled = false;

  calculateAllRemaining();
  
  popup.style.display = 'flex';
}

function renderReportLog(division, department) {
  const logContainer = document.getElementById("reportLogContainer");
  logContainer.innerHTML = ''; // ê¸°ì¡´ ë¡œê·¸ ì´ˆê¸°í™”

  // í•´ë‹¹ ë¶€ì„œ/í˜‘ë ¥ì‚¬ì˜ ë³´ê³ ì„œë§Œ í•„í„°ë§
  const filteredLogs = allReports.filter(report => 
    report.division === division && report.department === department
  ).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // ìµœì‹ ìˆœ ì •ë ¬

  if (filteredLogs.length === 0) {
    logContainer.innerHTML = '<p style="text-align:center; color:#777;">ì•„ì§ ë³´ê³ ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    return;
  }
  
  filteredLogs.forEach(log => {
    const logItem = document.createElement('div');
    logItem.className = 'report-log-item';
    const reportTime = new Date(log.timestamp).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    
    let visitorInfo = '';
    if (log.hasVisitor) {
      visitorInfo = `<br>- ë‚´ë°©ê° Â· í˜‘ë ¥ì—…ì²´: ì´ ${log.visitorTotal}ëª…, ëŒ€í”¼ì™„ë£Œ ${log.visitorEvacuated}ëª…, ë¯¸ëŒ€í”¼ ${log.visitorRemaining}ëª…`;
    }
    
    logItem.innerHTML = `
      <strong>[${reportTime}]</strong> ì„ì§ì›: ì´ ${log.total}ëª…, ëŒ€í”¼ì™„ë£Œ ${log.evacuated}ëª…, ë¯¸ëŒ€í”¼ ${log.remaining}ëª…
      ${visitorInfo}
      ${log.note ? `<br>- íŠ¹ì´ì‚¬í•­: ${log.note}` : ''}
    `;
    logContainer.appendChild(logItem);
  });
}

function closePopup() {
  document.getElementById("reportPopup").style.display = 'none';
}

function calculateAllRemaining() {
  const total = parseInt(document.getElementById("popupTotal").value) || 0;
  const evacuated = parseInt(document.getElementById("popupEvacuated").value) || 0;
  const remaining = total - evacuated;
  const saveBtn = document.getElementById("saveBtn");
  const remainingInfo = document.getElementById("remaining-info");
  let hasError = false;

  if (remaining < 0) {
    remainingInfo.innerHTML = `ë¯¸ëŒ€í”¼: <span class="negative-warning">âš ï¸ ìŒìˆ˜ì¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</span>`;
    hasError = true;
  } else {
    remainingInfo.innerHTML = `ë¯¸ëŒ€í”¼: ${remaining}ëª…`;
  }

  const hasVisitor = document.getElementById("popupHasVisitor").checked;
  const visitorTotal = hasVisitor ? parseInt(document.getElementById("popupVisitorTotal").value) || 0 : 0;
  const visitorEvacuated = hasVisitor ? parseInt(document.getElementById("popupVisitorEvacuated").value) || 0 : 0;
  const visitorRemaining = visitorTotal - visitorEvacuated;
  const visitorRemainingInfo = document.getElementById("visitor-remaining-info");

  if (hasVisitor) {
    if (visitorRemaining < 0) {
      visitorRemainingInfo.innerHTML = `ë‚´ë°©ê° Â· í˜‘ë ¥ì—…ì²´ ë¯¸ëŒ€í”¼: <span class="negative-warning">âš ï¸ ìŒìˆ˜ì¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</span>`;
      hasError = true;
    } else {
      visitorRemainingInfo.innerHTML = `ë‚´ë°©ê° Â· í˜‘ë ¥ì—…ì²´ ë¯¸ëŒ€í”¼: ${visitorRemaining}ëª…`;
    }
  } else {
    visitorRemainingInfo.innerHTML = '';
  }

  saveBtn.disabled = hasError;
}

async function saveReport() {
  const dataToSave = {
    division: currentReportData.division,
    department: currentReportData.department,
    total: parseInt(document.getElementById("popupTotal").value) || 0,
    evacuated: parseInt(document.getElementById("popupEvacuated").value) || 0,
    note: document.getElementById("popupNotes").value,
    hasVisitor: document.getElementById("popupHasVisitor").checked,
    visitorTotal: document.getElementById("popupHasVisitor").checked ? (parseInt(document.getElementById("popupVisitorTotal").value) || 0) : 0,
    visitorEvacuated: document.getElementById("popupHasVisitor").checked ? (parseInt(document.getElementById("popupVisitorEvacuated").value) || 0) : 0
  };

  try {
    const res = await fetch(`${WEBAPP_URL}`, {
      method: 'POST',
      body: JSON.stringify(dataToSave)
    });
    const result = await res.json();
    if (result.result === "success") {
      alert("ë³´ê³ ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      closePopup();
      fetchData(); // ë°ì´í„° ì¬í˜¸ì¶œ
    } else {
      alert("ë³´ê³  ì €ì¥ ì‹¤íŒ¨: " + result.error);
    }
  } catch (error) {
    console.error("Error saving report:", error);
    alert("ë³´ê³  ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
}

document.getElementById("syncBtn").addEventListener('click', fetchData);
document.getElementById("newReportBtn").addEventListener('click', () => {
  // íŒì—… ë‚´ ë³´ê³  í¼ì„ ë³´ì´ê²Œ í•¨
  document.getElementById("reportForm").style.display = 'block';
  document.getElementById("newReportBtn").style.display = 'none';
});
document.getElementById("saveBtn").addEventListener('click', saveReport);
document.getElementById("popupTotal").addEventListener('input', calculateAllRemaining);
document.getElementById("popupEvacuated").addEventListener('input', calculateAllRemaining);
document.getElementById("popupHasVisitor").addEventListener('change', () => {
    const visitorFieldsDiv = document.getElementById("visitorFields");
    visitorFieldsDiv.style.display = document.getElementById("popupHasVisitor").checked ? 'block' : 'none';
    calculateAllRemaining();
});
document.getElementById("popupVisitorTotal").addEventListener('input', calculateAllRemaining);
document.getElementById("popupVisitorEvacuated").addEventListener('input', calculateAllRemaining);


document.addEventListener('DOMContentLoaded', () => {
  fetchData();
  setInterval(fetchData, 30000);
});
</script>
</body>
</html>
