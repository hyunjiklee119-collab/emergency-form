<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>비상대피 보고폼</title>
  <style>
    body { font-family: sans-serif; margin: 15px; background:#f9f9f9; }
    h2 { text-align:center; margin-bottom: 15px; }
    .form-box { max-width: 480px; margin:auto; background:#fff; padding:15px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.2);}
    label { display:block; margin-top:10px; font-weight:bold; }
    input, select, textarea, button { width:100%; margin-top:5px; padding:8px; font-size:1rem; border-radius:5px; border:1px solid #ccc; }
    textarea { resize:none; }
    button { background:#007bff; color:#fff; border:none; cursor:pointer; margin-top:15px; }
    button:hover { background:#0056b3; }
    .note-tip { font-size:0.9rem; color:#555; margin-top:5px; }
    table { width:100%; border-collapse: collapse; margin-top:15px; }
    th, td { border:1px solid #ccc; padding:6px; text-align:center; font-size:0.9rem; }
    th { background:#f0f0f0; }
    .note-marker { color:red; cursor:pointer; font-weight:bold; }
  </style>
</head>
<body>

<h2>비상대피 인원 보고</h2>

<div class="form-box">
  <form id="reportForm">
    <label>보고자 성명</label>
    <input type="text" id="reporter" placeholder="성명 입력" required>

    <label>연락처</label>
    <input type="text" id="contact" placeholder="연락처 입력" required>

    <label>소속 사업부/실</label>
    <select id="division" required>
      <option value="">-- 선택 --</option>
      <option value="생산">생산</option>
      <option value="품질">품질</option>
      <option value="안전">안전</option>
    </select>

    <label>세부 팀/부서명</label>
    <input type="text" id="department" placeholder="부서명 입력" required>

    <label>대피대상자</label>
    <input type="number" id="total" min="0" required>

    <label>대피완료 인원</label>
    <input type="number" id="evacuated" min="0" required>

    <label>특이사항 (있으면 입력)</label>
    <textarea id="note" rows="3" placeholder="특이사항 입력 시 결과표에 * 표시"></textarea>
    <div class="note-tip">* 표시는 특이사항 입력 시 표시됩니다.</div>

    <button type="submit">제출</button>
  </form>
</div>

<div class="form-box">
  <h3>제출 결과</h3>
  <table id="resultTable">
    <thead>
      <tr>
        <th>보고자 성명</th>
        <th>연락처</th>
        <th>소속 사업부/실</th>
        <th>세부 팀/부서명</th>
        <th>대피대상자</th>
        <th>대피완료 인원</th>
        <th>미대피 인원</th>
        <th>특이사항</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxFNseGNQXwPEaL05dfBJI-tnvx1z2Celhs5oiQWRayJsf2cO4By3eeJVRMDvd2g6ckgw/exec";
  const tableBody = document.querySelector("#resultTable tbody");

  document.getElementById("reportForm").addEventListener("submit", async function(e){
    e.preventDefault();

    const reporter = document.getElementById("reporter").value;
    const contact = document.getElementById("contact").value;
    const division = document.getElementById("division").value;
    const department = document.getElementById("department").value;
    const total = parseInt(document.getElementById("total").value);
    const evacuated = parseInt(document.getElementById("evacuated").value);
    const remaining = total - evacuated;
    const note = document.getElementById("note").value;

    const data = {reporter, contact, division, department, total, evacuated, remaining, note};

    try {
      const res = await fetch(WEBAPP_URL, {
        method: "POST",
        mode: "cors",
        cache: "no-cache",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });

      const result = await res.json();

      if(result.result === "success"){
        alert("보고가 제출되었습니다.");

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${reporter}</td>
          <td>${contact}</td>
          <td>${division}</td>
          <td>${department}</td>
          <td>${total}</td>
          <td>${evacuated}</td>
          <td>${remaining}</td>
          <td>${note ? '<span class="note-marker" onclick="alert(\''+note.replace(/'/g,"\\'")+'\')">*</span>' : ''}</td>
        `;
        tableBody.appendChild(tr);

        this.reset();
      } else {
        alert("제출 실패: " + (result.error || "알 수 없는 오류"));
      }

    } catch(err) {
      console.error(err);
      alert("오류 발생: " + err);
    }
  });
</script>

</body>
</html>
