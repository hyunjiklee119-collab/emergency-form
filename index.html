<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ë¹„ìƒëŒ€í”¼ ì¸ì› ë³´ê³ </title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; background: #f0f2f5; color: #333; }
        h2 { text-align: center; margin: 1.5rem 0; color: #1a237e; }
        .form-container { display: flex; flex-direction: column; gap: 15px; max-width: 480px; margin: 20px auto; padding: 20px; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.95rem; color: #444; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; box-sizing: border-box; transition: border-color 0.3s; }
        input:focus, select:focus, textarea:focus { border-color: #007bff; outline: none; box-shadow: 0 0 0 3px rgba(0,123,255,0.25); }
        textarea { resize: vertical; min-height: 80px; }
        button { width: 100%; padding: 12px; background: #007bff; color: #fff; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: background-color 0.3s, transform 0.1s; margin-top: 10px; }
        button:hover { background: #0056b3; }
        button:active { transform: scale(0.99); }
        .note-tip { font-size: 0.85rem; color: #777; margin-top: 5px; text-align: right; }

        /* ë‚´ë°©ê° í¬í•¨ ì—¬ë¶€ ì²´í¬ë°•ìŠ¤ ê·¸ë£¹ (ìˆ˜ì •ë¨) */
        .checkbox-group {Â 
            display: flex !important;Â 
            align-items: center !important;
            gap: 5px !important;
            margin-top: 15px !important;
            width: auto !important;
        }
        
        .checkbox-group input[type="checkbox"] {Â 
            width: auto !important;
            margin: 0 !important;
            vertical-align: middle;
        }

        .checkbox-group label {Â 
            display: inline-block !important;
            font-weight: bold !important;
            font-size: 0.95rem !important;
            color: #007bff !important;
            margin: 0 !important;
            cursor: pointer !important;
            vertical-align: middle;
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            display: none;
        }
        .loading-btn {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .dashboard-link { text-align: right; margin-bottom: 20px; }
        @media (min-width: 768px) {
            .form-container { max-width: 600px; padding: 30px; margin: 40px auto; border-radius: 12px; }
            h2 { font-size: 2rem; }
            label { font-size: 1rem; }
        }
        /* ê°œì¸ì •ë³´ ë™ì˜ ì˜ì—­ */
        .privacy-consent-container { text-align: center; margin-top: 20px; }
        .privacy-consent-group { display: inline-flex; align-items: center; gap: 5px; white-space: nowrap; }
        .privacy-consent-group label { font-weight: bold; font-size: 0.95rem; color: #444; margin: 0; cursor: pointer; }
    </style>
</head>
<body>

<div class="form-container">
    <div class="dashboard-link">
        <a href="dashboard.html" target="_blank" style="color: #007bff; text-decoration: none; font-size: 0.9rem;">
            ğŸ“Š ë³´ê³  í˜„í™© ëŒ€ì‹œë³´ë“œ ë³´ê¸°
        </a>
    </div>
    <h2>ë¹„ìƒëŒ€í”¼ ì¸ì› ë³´ê³ </h2>
    <form id="reportForm">
        <label for="reporter">ë³´ê³ ì ì„±ëª…</label>
        <input type="text" id="reporter" placeholder="ì„±ëª… ì…ë ¥" required>

        <label for="contact">ì—°ë½ì²˜</label>
        <input type="tel" id="contact" placeholder="010-1234-5678" required>
        <div class="note-tip">ìˆ«ìë§Œ ì…ë ¥í•´ ì£¼ì„¸ìš”. í•˜ì´í”ˆ(-)ì€ ìë™ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤.</div>

        <label for="division">ì†Œì† ì‚¬ì—…ë¶€/ì‹¤</label>
        <select id="division" required>
            <option value="">-- ì„ íƒ --</option>
            <option value="SYSTEMì‚¬ì—…ë¶€">SYSTEMì‚¬ì—…ë¶€</option>
            <option value="INFRAì‚¬ì—…ë¶€">INFRAì‚¬ì—…ë¶€</option>
            <option value="ê²½ì˜ì§€ì›ì‹¤">ê²½ì˜ì§€ì›ì‹¤</option>
            <option value="ì§ì†(ì—°êµ¬ì†Œ, êµ¬ë§¤íŒ€, ì•ˆì „í™˜ê²½, ê¸€ë¡œë²ŒTF)">ì§ì†(ì—°êµ¬ì†Œ, êµ¬ë§¤íŒ€, ì•ˆì „í™˜ê²½, ê¸€ë¡œë²ŒTF)</option>
        </select>

        <label for="department">ì„¸ë¶€ íŒ€/ë¶€ì„œëª…</label>
        <select id="department" required></select>
        <div id="commonDeptNote" class="note-tip" style="display:block; color: #007bff; text-align: left;">
            * ì†Œì† ì‚¬ì—…ë¶€ì˜ ì†Œìˆ˜ íŒ€ì€ 'ì‚¬ì—…ë¶€ ê³µí†µ'ìœ¼ë¡œ ë³´ê³  ê°€ëŠ¥í•©ë‹ˆë‹¤.
        </div>

        <label for="total">ëŒ€í”¼ëŒ€ìƒì ìˆ˜</label>
        <input type="number" id="total" min="0" required>
        <div class="note-tip">í•´ë‹¹ ë¶€ì„œì˜ ì´ ì¸ì› ìˆ˜</div>

        <label for="evacuated">ëŒ€í”¼ì™„ë£Œ ì¸ì› ìˆ˜</label>
        <input type="number" id="evacuated" min="0" required>
        <div class="note-tip">ëŒ€í”¼ ì¥ì†Œì— ë„ì°©í•œ ì¸ì› ìˆ˜</div>

        <div class="checkbox-group">
            <input type="checkbox" id="hasVisitor" style="margin-right: 5px;">
            <label for="hasVisitor">ë‚´ë°©ê° Â· í˜‘ë ¥ì—…ì²´ í¬í•¨ ì—¬ë¶€</label>
        </div>

        <label for="visitorTotal" id="visitorTotalLabel" style="display:none;">ë‚´ë°©ê° Â· í˜‘ë ¥ì—…ì²´ ì´ ì¸ì›</label>
        <input type="number" id="visitorTotal" min="0" placeholder="0" style="display:none;">

        <label for="visitorEvacuated" id="visitorEvacuatedLabel" style="display:none;">ë‚´ë°©ê° Â· í˜‘ë ¥ì—…ì²´ ëŒ€í”¼ì™„ë£Œ ì¸ì›</label>
        <input type="number" id="visitorEvacuated" min="0" placeholder="0" style="display:none;">

        <label for="note">íŠ¹ì´ì‚¬í•­</label>
        <textarea id="note" rows="3" placeholder="íŠ¹ì´ì‚¬í•­ ì…ë ¥ (ì˜ˆ: ë¶€ìƒì ë°œìƒ, ì”ë¥˜ì ë°œìƒ ì‚¬ìœ  ë“±)"></textarea>

        <div class="privacy-consent-container">
            <div class="privacy-consent-group">
                <input type="checkbox" id="privacyConsent" name="privacyConsent" required>
                <label for="privacyConsent">ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤.</label>
            </div>
        </div>

        <button type="submit" id="submitBtn">
            <div class="loading-spinner"></div>
            ë³´ê³  ì œì¶œ
        </button>
    </form>
</div>

<script>
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyi307t8us1etL-I0P82NroRAcQAyjvi07v1NgqNAhUbzZDPLd3tZ_-ssGkzuXOVLl4/exec";

    const reportForm = document.getElementById("reportForm");
    const contactInput = document.getElementById("contact");
    const divisionSelect = document.getElementById("division");
    const departmentSelect = document.getElementById("department");
    const commonDeptNote = document.getElementById("commonDeptNote");
    const hasVisitorCheckbox = document.getElementById("hasVisitor");

    const visitorTotalLabel = document.getElementById("visitorTotalLabel");
    const visitorTotalInput = document.getElementById("visitorTotal");
    const visitorEvacuatedLabel = document.getElementById("visitorEvacuatedLabel");
    const visitorEvacuatedInput = document.getElementById("visitorEvacuated");

    const submitBtn = document.getElementById("submitBtn");
    const loadingSpinner = submitBtn.querySelector(".loading-spinner");

    const departments = {
        'SYSTEMì‚¬ì—…ë¶€': ['ì‚¬ì—…ë¶€ ê³µí†µ', 'ì˜ì—…íŒ€', 'CSíŒ€', 'ì œì¡°íŒ€', 'ìƒì‚°ê¸°ìˆ íŒ€', 'í’ˆì§ˆG'],
        'INFRAì‚¬ì—…ë¶€': ['ì‚¬ì—…ë¶€ ê³µí†µ', 'ENCì‚¬ì—…íŒ€', 'EPCì‚¬ì—…íŒ€'],
        'ê²½ì˜ì§€ì›ì‹¤': ['ì‚¬ì—…ë¶€ ê³µí†µ', 'ì¬ë¬´íŒ€', 'ì¸ì‚¬íŒ€', 'ì •ë³´ì „ëµíŒ€', 'ê¸°íšG', 'ì¤€ë²•ê²½ì˜G'],
        'ì§ì†(ì—°êµ¬ì†Œ, êµ¬ë§¤íŒ€, ì•ˆì „í™˜ê²½, ê¸€ë¡œë²ŒTF)': ['ì‚¬ì—…ë¶€ ê³µí†µ', 'ì—°êµ¬ì†Œ', 'êµ¬ë§¤íŒ€', 'ì•ˆì „í™˜ê²½íŒ€', 'ê¸€ë¡œë²ŒTF']
    };

    hasVisitorCheckbox.addEventListener('change', function() {
        if (this.checked) {
            visitorTotalLabel.style.display = 'block';
            visitorTotalInput.style.display = 'block';
            visitorEvacuatedLabel.style.display = 'block';
            visitorEvacuatedInput.style.display = 'block';
            visitorTotalInput.setAttribute('required', 'required');
            visitorEvacuatedInput.setAttribute('required', 'required');
            visitorTotalInput.value = '';
            visitorEvacuatedInput.value = '';
        } else {
            visitorTotalLabel.style.display = 'none';
            visitorTotalInput.style.display = 'none';
            visitorEvacuatedLabel.style.display = 'none';
            visitorEvacuatedInput.style.display = 'none';
            visitorTotalInput.removeAttribute('required');
            visitorEvacuatedInput.removeAttribute('required');
            visitorTotalInput.value = '0';
            visitorEvacuatedInput.value = '0';
        }
    });

    divisionSelect.addEventListener('change', function() {
        const selectedDivision = this.value;
        const subDepartments = departments[selectedDivision] || [];
        departmentSelect.innerHTML = '';

        departmentSelect.style.display = 'block';
        commonDeptNote.style.display = 'block';
        
        const defaultOption = document.createElement('option');
        defaultOption.text = '-- ì„ íƒ --';
        defaultOption.value = '';
        departmentSelect.appendChild(defaultOption);

        subDepartments.forEach(dept => {
            const option = document.createElement('option');
            option.value = dept;
            option.text = dept;
            departmentSelect.appendChild(option);
        });
    });

    contactInput.addEventListener("input", function(e) {
        const value = e.target.value.replace(/\D/g, "");
        const originalLength = value.length;
        let formattedValue = "";

        if (originalLength > 0) {
            if (value.startsWith("02")) {
                if (originalLength > 2) {
                    formattedValue += value.substring(0, 2) + "-";
                    if (originalLength > 6) {
                        formattedValue += value.substring(2, 6) + "-";
                        formattedValue += value.substring(6, 10);
                    } else {
                        formattedValue += value.substring(2, 6);
                    }
                } else {
                    formattedValue = value;
                }
            } else {
                if (originalLength > 3) {
                    formattedValue += value.substring(0, 3) + "-";
                    if (originalLength > 7) {
                        formattedValue += value.substring(3, 7) + "-";
                        formattedValue += value.substring(7, 11);
                    } else {
                        formattedValue += value.substring(3, 7);
                    }
                } else {
                    formattedValue = value;
                }
            }
        }
        e.target.value = formattedValue;
    });

    reportForm.addEventListener("submit", async function(e){
        e.preventDefault();

        const privacyConsent = document.getElementById("privacyConsent").checked;
        if (!privacyConsent) {
            alert("ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•´ì•¼ ë³´ê³ ë¥¼ ì œì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
        }

        const reporter = document.getElementById("reporter").value;
        const contact = document.getElementById("contact").value;
        const division = divisionSelect.value;
        const department = departmentSelect.value;
        const total = parseInt(document.getElementById("total").value);
        const evacuated = parseInt(document.getElementById("evacuated").value);
        const note = document.getElementById("note").value;

        const hasVisitor = hasVisitorCheckbox.checked;
        const visitorTotal = hasVisitor ? parseInt(visitorTotalInput.value) : 0;
        const visitorEvacuated = hasVisitor ? parseInt(visitorEvacuatedInput.value) : 0;

        if (!reporter || !contact || !division || !department || isNaN(total) || isNaN(evacuated)) {
            alert("ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        if (hasVisitor && (isNaN(visitorTotal) || isNaN(visitorEvacuated))) {
            alert("ë‚´ë°©ê° Â· í˜‘ë ¥ì—…ì²´ ì¸ì›ì„ ìˆ«ìë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }
        if (hasVisitor && visitorEvacuated > visitorTotal) {
            alert("ë‚´ë°©ê° Â· í˜‘ë ¥ì—…ì²´ ëŒ€í”¼ì™„ë£Œ ì¸ì›ì´ ë‚´ë°©ê° ì´ ì¸ì›ë³´ë‹¤ ë§ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        const remaining = total - evacuated;
        if (remaining < 0) {
            alert("ëŒ€í”¼ì™„ë£Œ ì¸ì›ì´ ëŒ€í”¼ëŒ€ìƒìë³´ë‹¤ ë§ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        const data = {reporter, contact, division, department, total, evacuated, remaining, note, hasVisitor, visitorTotal, visitorEvacuated};

        submitBtn.disabled = true;
        submitBtn.classList.add('loading-btn');
        loadingSpinner.style.display = 'block';
        submitBtn.childNodes[1].nodeValue = ' ì œì¶œ ì¤‘...';

        try {
            const res = await fetch(WEBAPP_URL, {
                method: "POST",
                cache: "no-cache",
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify(data)
            });

            const result = await res.json();

            if (result.result === "success") {
                alert("ë³´ê³ ê°€ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.");
                reportForm.reset();
            } else {
                alert("ì œì¶œ ì‹¤íŒ¨: " + (result.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
            }

        } catch(err) {
            console.error(err);
            alert("ì˜¤ë¥˜ ë°œìƒ: ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.");
        } finally {
            submitBtn.disabled = false;
            submitBtn.classList.remove('loading-btn');
            loadingSpinner.style.display = 'none';
            submitBtn.childNodes[1].nodeValue = 'ë³´ê³  ì œì¶œ';
        }
    });
</script>

</body>
</html>
